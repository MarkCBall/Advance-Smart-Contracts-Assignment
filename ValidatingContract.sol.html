<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/ValidatingContract.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> ValidatingContract.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>68/68</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>45/48</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>20/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>66/66</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">217×</span>
<span class="cline-any cline-yes">103×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">216×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">213×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">212×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">152×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">152×</span>
<span class="cline-any cline-yes">152×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">712×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">178×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">172×</span>
<span class="cline-any cline-yes">89×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">156×</span>
<span class="cline-any cline-yes">81×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">75×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">152×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">212×</span>
<span class="cline-any cline-yes">212×</span>
<span class="cline-any cline-yes">5277×</span>
<span class="cline-any cline-yes">5277×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">210×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">111×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">32×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">358×</span>
<span class="cline-any cline-yes">145×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">213×</span>
<span class="cline-any cline-yes">209×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">198×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">253×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">222×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5828×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6303×</span>
<span class="cline-any cline-yes">6303×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity 0.5.0;
&nbsp;
contract ValidatingContract{
&nbsp;
    //PUBLIC FUNCTIONS
    function p1Won(uint data) public pure returns(bool){
        if (!blackHasPieces(data))
            return true;
        if (!redHasPieces(data))
            return false;
        revert("neither player has won");
    }
    function p1MovedLast(uint data) public pure returns (bool){
        return red(getPieceNumMoved(data)); 
    }
    // function gameTied(uint) public pure returns(bool){
    //     //NOT IMPLIMENTED
    //     return false;
    // }
    // function validStateUpdate(uint256 oldData, uint256 newData) public pure returns(uint){
    function validStateUpdate(uint256 oldData, uint256 newData) public pure returns(bool){
        uint pieceNumMoved = getPieceNumMoved(newData);
        uint pieceNumJumped = getPieceNumJumped(newData);
        uint pieceInPlayNew = getPieceByNum(newData, pieceNumMoved);
        uint pieceInPlayOld = getPieceByNum(oldData, pieceNumMoved);
        uint newRow = rowNum(pieceInPlayNew);
        uint newCol = colNum(pieceInPlayNew);
        uint oldRow = rowNum(pieceInPlayOld);
        uint oldCol = colNum(pieceInPlayOld);
        
        //turn number must increment by one
        require((getNonce(oldData)+1) == getNonce(newData),"improper nonce");
        // to be a queen it must have moved to row 0 or 7 or previously been a queen
        if(queen(pieceInPlayNew)){
            require((newRow == 0) || (newRow == 7) || queen(pieceInPlayOld), "improper queening");
        }
        //red plays on odd turns, black plays on even turns
        require( red(pieceNumMoved) == (getNonce(newData)%2 == 1) ,"moving wrong colored piece");
        //red moves to higher row numbers, black moves lower - queens move either way
        require(queen(pieceInPlayNew) || correctDirection(red(pieceNumMoved), newRow, oldRow), "normal pieces can't go backwards");
        //the piece must be moved to an empty square
        require(isEmpty(oldData,newRow,newCol), "can't move into an occupied square");
        
        uint calcData = oldData;
        uint maxMove = 1;
        //if a piece was jumped
        if(pieceNumJumped != 0){
            //piece can be moved two squares away
            maxMove = 2;
            //kill the piece if one was jumped and update state accordingly
            calcData = jumpAndUpdate(
                oldData,
                pieceNumJumped,
                newRow,
                newCol,
                oldRow,
                oldCol
            );
        }
        //the location the piece moved to must be a diagonal move
        locChangeValid(newRow,newCol,oldRow,oldCol,maxMove);        
        //change the old piece into the new piece
        //note that XOR is associative so XORing old data twice with new data results in new data
        calcData = XORPieceByte(
            calcData, 
            pieceNumMoved,
            (pieceInPlayNew ^ pieceInPlayOld)
        );
        //check state is as calculated aside from movement instructions
        <span class="missing-if-branch" title="else path not taken" >E</span>require((calcData &lt;&lt; 64) == (newData &lt;&lt; 64),"could not re-compute state"); 
        return true;
    }
    function getNonce(uint data) public pure returns(uint){
        //shift it over by 24 bytes and take five bytes
        return (data &gt;&gt; 192) % 1099511627776 ;
    }
    ////////////////END PUBLIC FUNCTIONS///////////////////////////////
&nbsp;
&nbsp;
&nbsp;
    //Helper functions
    function locChangeValid(uint newRow, uint newCol, uint oldRow, uint oldCol, uint maxMove) internal pure returns(bool){
        //the piece must land on a same colored square
        require(((newRow+newCol) % 2) == 0,"not moving to a colored square");
        // the piece can't move horizontally or vertically
        require( (oldRow != newRow) &amp;&amp; (oldCol != newCol), "can't move straight");
        //the piece can't move too far
        if (newRow&gt;oldRow){
            require((oldRow+maxMove)&gt;=newRow,"moving too far down");
        }else{
            require((newRow+maxMove)&gt;=oldRow,"moving too far up");
        }
        if (newCol&gt;oldCol){
            require((oldCol+maxMove)&gt;=newCol,"moving too far right");
        }else{
            <span class="missing-if-branch" title="else path not taken" >E</span>require((newCol+maxMove)&gt;=oldCol,"moving too far left");
        }
        return true;
    }
    function isEmpty(uint data, uint row, uint col) internal pure returns(bool){
        uint pce;
        for (uint i = 0; i&lt;25;i++){
            pce = getPieceByNum(data, i);
            if ((rowNum(pce)==row) &amp;&amp; (colNum(pce)==col) &amp;&amp; active(pce)){
                return false;
            }
        }
        return true;
    }
    function correctDirection(bool red, uint newRow, uint oldRow) internal pure returns(bool){
        return (   
            (red &amp;&amp; newRow &gt; oldRow) ||
            (!red &amp;&amp; oldRow &gt; newRow)
        );
    }
    function jumpAndUpdate(uint data,uint pieceNumJumped, uint newRow, uint newCol, uint oldRow, uint oldCol) internal pure returns(uint){
        uint jmpdPce = getPieceByNum(data, pieceNumJumped);
        <span class="missing-if-branch" title="else path not taken" >E</span>require(
            ((oldRow+newRow) == rowNum(jmpdPce)*2) &amp;&amp;
            ((oldCol+newCol) == colNum(jmpdPce)*2)
            ,"attempting to jump an invalid piece"
        );
        return XORPieceByte(data, pieceNumJumped, jmpdPce);
    }
    function redHasPieces(uint data) internal pure returns(bool){
        for (uint i = 0; i &lt; 13;i++){
            if (active(getPieceByNum(data,i))){
                return true;
            }
        }
    }
    function blackHasPieces(uint data) internal pure returns(bool){
        for (uint i = 13; i &lt; 25;i++){
            if (active(getPieceByNum(data,i))){
                return true;
            }
        }
    }
    function red(uint pNum) internal pure returns(bool){
        if (pNum &lt; 13 &amp;&amp; pNum &gt; 0){
            return true;
        }
        if (pNum &lt;25 &amp;&amp; pNum &gt; 0){
            return false;
        }
        revert("invalid piece number");
    }
    function active(uint pInt) internal pure returns(bool){ return (pInt&gt;127); }
    function queen(uint pInt) internal pure returns(bool){ return ((pInt%128) &gt; 63 ); }
    function rowNum(uint pInt) internal pure returns(uint){ return ((pInt%64) &gt;&gt; 3); }
    function colNum(uint pInt) internal pure returns(uint){ return (pInt%8); }
&nbsp;
    function XORPieceByte(uint data, uint pieceNum, uint bte) internal pure returns(uint){
        return ( data ^ (bte &lt;&lt; (192 - (pieceNum*8))) );
    }
    function getPieceNumMoved(uint data) internal pure returns(uint){
        return getByteAt(data, 0);
    }
    function getPieceNumJumped(uint data) internal pure returns(uint){
        return getByteAt(data, 1);
    }
    function getPieceByNum(uint data, uint n) internal pure returns(uint bte){
        return getByteAt(data, n+7);
    }
    function getByteAt(uint data, uint n) internal pure returns(uint bte){
        assembly{bte := byte(n,data)}
        return bte;
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Apr 03 2019 20:58:55 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
